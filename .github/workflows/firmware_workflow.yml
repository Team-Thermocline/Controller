name: Firmware

on:
  push:
    branches:
      - "main"
    tags:
      - "*"
  pull_request:
    paths:
      - "Firmware/**"
      - ".github/workflows/**"

env:
  FLASH_TOTAL_KB: 2048
  RAM_TOTAL_KB: 264

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            git \
            pkg-config \
            python3 \
            gcc-arm-none-eabi \
            libnewlib-arm-none-eabi \
            libstdc++-arm-none-eabi-newlib \
            libusb-1.0-0-dev

      - name: Configure
        run: |
          rm -rf Firmware/build
          mkdir -p Firmware/build
          cd Firmware/build
          cmake ..

      - name: Build
        run: |
          cd Firmware/build
          make -j"$(nproc)" 2>&1 | tee build_output.txt

      - name: Extract binary size and memory usage
        id: size
        run: |
          cd Firmware/build
          test -f thermocline_controller.elf || { echo "::error::Build did not produce thermocline_controller.elf"; exit 1; }
          size_line=$(arm-none-eabi-size thermocline_controller.elf | sed -n '2p')
          set -- $size_line
          text=$1 data=$2 bss=$3
          FLASH_USED=$((text + data))
          RAM_USED=$((data + bss))
          echo "flash_used=$FLASH_USED" >> $GITHUB_OUTPUT
          echo "flash_used_kb=$((FLASH_USED / 1024))" >> $GITHUB_OUTPUT
          echo "flash_percent=$((FLASH_USED * 100 / (FLASH_TOTAL_KB * 1024)))" >> $GITHUB_OUTPUT
          echo "ram_used=$RAM_USED" >> $GITHUB_OUTPUT
          echo "ram_used_kb=$((RAM_USED / 1024))" >> $GITHUB_OUTPUT
          echo "ram_percent=$((RAM_USED * 100 / (RAM_TOTAL_KB * 1024)))" >> $GITHUB_OUTPUT
        env:
          FLASH_TOTAL_KB: ${{ env.FLASH_TOTAL_KB }}
          RAM_TOTAL_KB: ${{ env.RAM_TOTAL_KB }}

      - name: Send to Discord
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          GIT_VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "unknown")
          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -sS -H "Content-Type: application/json" -d "{
              \"embeds\": [{
                \"title\": \"Firmware Build - thermocline_controller\",
                \"description\": \"**${GIT_VERSION}** built successfully.\",
                \"color\": 3066993,
                \"fields\": [
                  {\"name\": \"Flash\", \"value\": \"${{ steps.size.outputs.flash_percent }}% (${{ steps.size.outputs.flash_used_kb }} KB / ${{ env.FLASH_TOTAL_KB }} KB)\", \"inline\": true},
                  {\"name\": \"RAM (static)\", \"value\": \"${{ steps.size.outputs.ram_percent }}% (${{ steps.size.outputs.ram_used_kb }} KB / ${{ env.RAM_TOTAL_KB }} KB)\", \"inline\": true},
                  {\"name\": \"Build\", \"value\": \"[View run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": false}
                ],
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" "$DISCORD_WEBHOOK"
          else
            echo "Flash: ${{ steps.size.outputs.flash_percent }}% | RAM: ${{ steps.size.outputs.ram_percent }}% | ${GIT_VERSION}"
          fi

      - name: Upload UF2 artifact
        uses: actions/upload-artifact@v4
        with:
          name: thermocline_controller-uf2
          path: Firmware/build/*.uf2
          if-no-files-found: error
